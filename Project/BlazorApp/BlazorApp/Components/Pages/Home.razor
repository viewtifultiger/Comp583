@page "/Home"
@rendermode InteractiveServer
@inject NavigationManager NavigationManager
@inject IHttpContextAccessor HttpContextAccessor
@inject AppDbContext DbContext
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@using BlazorApp.Models
@using Microsoft.EntityFrameworkCore;

<PageTitle>Home</PageTitle>

<h1>Appointment Scheduling System</h1>

@if (FullName != null)
{
    <p>Welcome, @FullName!</p>
}
else
{
    <p>Loading user info...</p>
}

<button class="btn btn-primary" @onclick="GoToLoginPage">Logout</button>

@code {
    private string? FullName;

    protected override async Task OnInitializedAsync()
    {
        var user = HttpContextAccessor.HttpContext?.User;

        if (user?.Identity?.IsAuthenticated == true)
        {
            var email = user.FindFirst(ClaimTypes.Name)?.Value;

            if (!string.IsNullOrEmpty(email))
            {
                // Check all user roles
                var doctor = await DbContext.Doctors.FirstOrDefaultAsync(d => d.Email == email);
                var patient = await DbContext.Patients.FirstOrDefaultAsync(p => p.Email == email);
                var admin = await DbContext.Admins.FirstOrDefaultAsync(a => a.Email == email);

                if (doctor != null)
                    FullName = $"{doctor.FirstName} {doctor.LastName}";
                else if (patient != null)
                    FullName = $"{patient.FirstName} {patient.LastName}";
                else if (admin != null)
                    FullName = $"{admin.FirstName} {admin.LastName}";
            }
        }
    }

    private void GoToLoginPage()
    {
        NavigationManager.NavigateTo("/Login");
    }
}

